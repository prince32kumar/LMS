stages:
  - changeset
  - build
  - sast
  - dependency
include:
 - template: Security/SAST.gitlab-ci.yml
 - template: Security/Dependency-Scanning.gitlab-ci.yml

Changeset:
  stage: changeset
  tags:
    - Docker
  image: bitnami/git:latest
  script:
    - mkdir /builds/balic/baliclms/
    - mkdir -p Target
    - echo $CI_COMMIT_TAG
   # Modified files
    - |
      if [[ $CI_COMMIT_TAG == Prod_* ]];
      then 
        CI_PREVIOUS_COMMIT=$CI_PREVIOUS_COMMIT_PROD
      fi
      if [[ $CI_COMMIT_TAG == SIT_* ]];
      then 
        CI_PREVIOUS_COMMIT=$CI_PREVIOUS_COMMIT_SIT
      fi
      if [[ $CI_COMMIT_TAG == UAT_* ]];
      then 
        CI_PREVIOUS_COMMIT=$CI_PREVIOUS_COMMIT_UAT
      fi  
    - echo $CI_PREVIOUS_COMMIT
    - echo $CI_PREVIOUS_COMMIT_PROD
    - echo $CI_PREVIOUS_COMMIT_SIT
    - echo $CI_PREVIOUS_COMMIT_UAT   
    - mfiles=$(git diff $CI_PREVIOUS_COMMIT HEAD --name-only --diff-filter=d)
    - echo $mfiles
    - |
      if [ ! -z "$mfiles" ];
      then
        echo "$mfiles" | while IFS= read -r line ; do echo $line; cp -rf --parents "$line" Target; done
        # cp -rv --parents "$mfiles" Target;
      else
        echo "No modified files";
      fi
    # If there are no modified files files
    - if [[ -z $mfiles ]];
      then
        echo "NO changes found";
        exit 1;
      fi
  artifacts:
    paths:
      
      - "/builds/balic/baliclms/"
    expire_in: 1 week
  rules:
    - if: $CI_COMMIT_TAG =~ /^UAT_.*/
    - if: $CI_COMMIT_TAG =~ /^SIT_.*/
    - if: $CI_COMMIT_TAG =~ /^PROD_.*/
    # - if [[ -d "Target/Unix_Structure" ]]; then
    #    echo "Changes found to build"

   

    #   else

    #       echo "No changes to build"

    #    fi
      
   

    
build:
  stage: build
  image: 'maven:latest'
  tags:
    - Docker
  script:
    - whoami
    - mvn -f BalicLms/pom.xml clean install package
  only:
   changes:
     - BalicLms/src/**

  artifacts:
    paths:
      - /builds/balic/baliclms/BalicLms/target/*.war
sast:
  stage: sast
  tags:
    - Docker
  script: mkdir /builds/balic/baliclms/secure.txt
  artifacts:
    paths:
      - gl-sast-report.json
      - /builds/balic/baliclms/secure.txt
    reports:
      sast: gl-sast report.json
dependency_scanning:
  stage: dependency
  tags:
    - Docker
  artifacts:
    paths:
      - gl-dependency-scanning-report.json
    reports:
      dependency_scanning: gl-dependency-scanning-report.json
